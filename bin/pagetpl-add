#!/usr/bin/env node

const program = require('commander'); 
const inquirer = require('inquirer'); 
const chalk = require('chalk');
const fs = require('fs');
const join = require('path').join;
const mkdirpSync = require('fs-extra').mkdirpSync;

const checkVersion = require('../lib/check-version');
const logger = require('../lib/logger');
let generate = require('../lib/generate');
const config = require('../lib/config')

/**
 * Usage.
 */

program
    .usage('<template-name>')

/**
 * Help.
 */

program.on('--help', () => {
    logger.tips('  Examples:')
    logger.tips()
    logger.tips(chalk.gray('    # create a new dva-page to your management system'))
    logger.tips('    $ pagetpl add dva-page')
    logger.tips()
    logger.tips(chalk.gray('    # create a new redux-page to your management system'))
    logger.tips('    $ pagetpl add redux-page')
    logger.tips()
})

function help() {
    // è‹¥æ²¡æœ‰è¾“å…¥æ¨¡æ¿ è¿”å›å¸®åŠ©ä¿¡æ¯ 
    program.parse(process.argv);
    if (program.args.length < 1) {
        return program.help();
    }
}

help();
/**
 * Padding.
 */

logger.tips()
process.on('exit', () => {
  logger.tips()
})


let templateName = program.args[0];

if (templateName === "dva-page") {
    const currentPath =  process.cwd()
    logger.tips(chalk.blue(`   ğŸ¡  å½“å‰ç›®å½•: ã€ ${currentPath} ã€‘`))
    logger.tips()
} else if (templateName === "redux-page") {
    logger.tips(chalk.blue('    ğŸ˜¢  ä½ å¯ä»¥å…ˆè¯•è¯•dvaç‰ˆæœ¬ reduxç‰ˆæœ¬çš„é¡µé¢æ¨¡æ¿è¿˜åœ¨å®šä¹‰ä¸­~  â˜•ï¸  â˜•ï¸  â˜•ï¸  '))
    return
} else {
    return program.help();
}


  inquirer.prompt([{
    type: 'confirm',
    message:'ç¡®å®šä¸Šé¢ ğŸ‘†  çš„ç›®å½•æ˜¯é¡¹ç›®æ ¹ç›®å½•? å°†åœ¨è¯¥ç›®å½•ä¸‹ç”Ÿæˆé¡µé¢~',
    name:'ok'
  }]).then(answers => {
    if (answers.ok) {
        // å½“å‰ src/routes/ ä¸‹çš„æ–‡ä»¶å¤¹ä¸ªæ•°
        const routesPath = join(process.cwd(), config.pageRoot)
        let defaultPage = `Page1`
        let defaultChineseName = `æ–°çš„é¡µé¢1`;
        if (fs.existsSync(routesPath)){
            const oldPagelist = fs.readdirSync(routesPath)
            const oldPagelistLenth = oldPagelist.length + 1
            
            defaultPage = `Page${oldPagelistLenth}`
            defaultChineseName = `æ–°çš„é¡µé¢${oldPagelistLenth}`;
        }
        
      startAdd(defaultPage,defaultChineseName)
    }
  }).catch((err)=>{
    logger.error(`pagetpl-cli error: ${err.message.trim()}`)
  })

  // æ”¶é›†é¡µé¢ä¿¡æ¯
  function startAdd(defaultPage,defaultChineseName){
        const questions = [{
        type: 'input',
        message: 'è¯·è¾“å…¥é¡µé¢æ–‡ä»¶å¤¹çš„åå­—:',
        name: 'folderName',
        default: defaultPage, // é»˜è®¤å€¼
        validate: function(val) {
            if (/^[A-Za-z0-9]{3,20}$/.test(val)) { // æ˜¯å¦æ˜¯å­—ç¬¦ä¸²
                return true;
            } else {
                return "è¯·è¾“å…¥3-20ä½çš„è‹±æ–‡æˆ–æ•°å­—";
            }
        }
    }, {
        type: 'input',
        message: 'è¯·è¾“å…¥æ–°å¢é¡µé¢çš„åå­—:',
        name: 'pageName',
        default: defaultPage, // é»˜è®¤å€¼
        validate: function(val) {
            if (/^[A-Za-z0-9]{3,20}$/.test(val)) { // æ˜¯å¦æ˜¯å­—ç¬¦ä¸²
                return true;
            } else {
                return "è¯·è¾“å…¥3-20ä½çš„è‹±æ–‡æˆ–æ•°å­—";
            }
        }
    }, {
        type: 'input',
        message: 'è¯·è¾“å…¥æ–°å¢é¡µé¢çš„ä¸­æ–‡åå­—:',
        name: 'chineseName',
        default: defaultChineseName, // é»˜è®¤å€¼
        validate: function(val) {
            if (/^[\u4E00-\u9FA50-9]{2,20}$/.test(val)) { // æ˜¯å¦æ˜¯ä¸­æ–‡
                return true;
            } else {
                return "è¯·è¾“å…¥3-20ä½çš„ä¸­æ–‡æˆ–æ•°å­—";
            }
        }
    }
    ,{
        type: "confirm",
        message: "æ˜¯å¦è‡ªåŠ¨é…ç½®modelså’Œservicesï¼Ÿ",
        name: "addModel"
    }]


    inquirer.prompt(questions).then((answers) => {
        if (answers) {
            runtask(answers)
        }
    })
  }


/**
 *  ç‰ˆæœ¬æ£€æµ‹ é¡µé¢ç”Ÿæˆ.
 */
function runtask(answers) {
    // æ£€æµ‹æ˜¯å¦æœ‰æ–°çš„cliç‰ˆæœ¬
    checkVersion(() => {
      // ç”Ÿæˆæ–‡ä»¶
        generate(answers.folderName,answers.pageName,answers.chineseName,answers.addModel)
      
    })
}


